name: Release

on:
  push:
    tags: ['v*']

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for changelog generation

      - name: Extract version from tag
        id: version
        run: |
          # Remove 'v' prefix from tag for version number
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG_VERSION=$GITHUB_REF_NAME" >> $GITHUB_ENV
          echo "Building version: $VERSION (tag: $GITHUB_REF_NAME)"

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Verify HytaleServer.jar exists
        run: |
          if [ ! -f libs/HytaleServer.jar ]; then
            echo "::error::libs/HytaleServer.jar not found in repository!"
            exit 1
          fi
          echo "Found HytaleServer.jar ($(du -h libs/HytaleServer.jar | cut -f1))"

      - name: Update manifest versions
        run: |
          # Update runtime plugin manifest
          sed -i "s/\"Version\": \"[^\"]*\"/\"Version\": \"$VERSION\"/" src/main/resources/manifest.json

          # Update early plugin manifest
          sed -i "s/\"Version\": \"[^\"]*\"/\"Version\": \"$VERSION\"/" hyfixes-early/src/main/resources/manifest.json

          # Update bundle manifest
          sed -i "s/\"Version\": \"[^\"]*\"/\"Version\": \"$VERSION\"/" bundle/manifest.json

          echo "Updated all manifests to version $VERSION"

      - name: Build Runtime Plugin
        run: ./gradlew build -Pversion=${{ env.TAG_VERSION }}

      - name: Build Early Plugin
        run: ./gradlew :hyfixes-early:build -Pversion=${{ env.TAG_VERSION }}

      - name: Generate changelog with LLM
        id: changelog
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
          RELEASE_VERSION: ${{ env.VERSION }}
        run: |
          chmod +x .github/scripts/generate-changelog.sh
          CHANGELOG=$(.github/scripts/generate-changelog.sh)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create versioned artifacts and bundle
        run: |
          mkdir -p dist

          # Copy JARs with versioned names
          cp build/libs/hyfixes-*.jar "dist/hyfixes-${VERSION}.jar" 2>/dev/null || \
            cp build/libs/hyfixes.jar "dist/hyfixes-${VERSION}.jar"

          cp hyfixes-early/build/libs/hyfixes-early-*.jar "dist/hyfixes-early-${VERSION}.jar" 2>/dev/null || \
            cp hyfixes-early/build/libs/hyfixes-early.jar "dist/hyfixes-early-${VERSION}.jar"

          # Prepare bundle structure
          mkdir -p dist/bundle/mods dist/bundle/earlyplugins
          cp "dist/hyfixes-${VERSION}.jar" dist/bundle/mods/
          cp "dist/hyfixes-early-${VERSION}.jar" dist/bundle/earlyplugins/
          cp bundle/manifest.json dist/bundle/
          cp CURSEFORGE.md dist/bundle/README.md 2>/dev/null || echo "No CURSEFORGE.md found"

          # Create bundle ZIP
          cd dist/bundle
          zip -r "../hyfixes-bundle-v${VERSION}.zip" .
          cd ../..

          echo "=== Created artifacts ==="
          ls -la dist/

      - name: Verify versions in JARs
        run: |
          echo "=== Version Verification ==="
          echo "Tag version: $VERSION"
          echo "Runtime manifest: $(unzip -p dist/hyfixes-${VERSION}.jar manifest.json | grep -o '"Version": "[^"]*"')"
          echo "Early manifest: $(unzip -p dist/hyfixes-early-${VERSION}.jar manifest.json | grep -o '"Version": "[^"]*"')"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: HyFixes v${{ env.VERSION }}
          body: ${{ steps.changelog.outputs.content }}
          files: |
            dist/hyfixes-${{ env.VERSION }}.jar
            dist/hyfixes-early-${{ env.VERSION }}.jar
            dist/hyfixes-bundle-v${{ env.VERSION }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # CurseForge upload - disabled until Hytale is available on CurseForge
      # - name: Upload to CurseForge
      #   continue-on-error: true
      #   uses: itsmeow/curseforge-upload@v3
      #   with:
      #     token: ${{ secrets.CURSEFORGE_TOKEN }}
      #     project_id: ${{ secrets.CURSEFORGE_PROJECT_ID }}
      #     game_endpoint: hytale
      #     file_path: dist/hyfixes-bundle-v${{ env.VERSION }}.zip
      #     display_name: "HyFixes v${{ env.VERSION }}"
      #     changelog: ${{ steps.changelog.outputs.content }}
      #     changelog_type: markdown
      #     release_type: release

      - name: Send Discord notification
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          CHANGELOG: ${{ steps.changelog.outputs.content }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            # Truncate changelog if too long for Discord (max 4096 for embed description)
            CHANGELOG_TRUNCATED=$(echo "$CHANGELOG" | head -c 1800)
            if [ ${#CHANGELOG} -gt 1800 ]; then
              CHANGELOG_TRUNCATED="${CHANGELOG_TRUNCATED}..."
            fi

            # Build JSON payload properly with jq
            PAYLOAD=$(jq -n \
              --arg title "HyFixes v${VERSION} Released!" \
              --arg changelog "$CHANGELOG_TRUNCATED" \
              --arg url "https://github.com/${{ github.repository }}/releases/tag/${TAG_VERSION}" \
              '{
                embeds: [{
                  title: $title,
                  description: $changelog,
                  color: 5814783,
                  fields: [
                    {
                      name: "Downloads",
                      value: "[GitHub Release](\($url))",
                      inline: false
                    }
                  ],
                  footer: {
                    text: "HyFixes - Bug fixes for Hytale servers"
                  },
                  url: $url
                }]
              }')

            curl -H "Content-Type: application/json" \
              -X POST \
              -d "$PAYLOAD" \
              "$DISCORD_WEBHOOK"
          fi
