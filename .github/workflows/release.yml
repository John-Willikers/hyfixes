name: Release

on:
  push:
    tags: ['v*']

env:
  HYTALE_SERVER_URL: ${{ secrets.HYTALE_SERVER_URL }}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for changelog generation

      - name: Extract version from tag
        id: version
        run: |
          # Remove 'v' prefix from tag for version number
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG_VERSION=$GITHUB_REF_NAME" >> $GITHUB_ENV
          echo "Building version: $VERSION (tag: $GITHUB_REF_NAME)"

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Download HytaleServer.jar
        run: |
          mkdir -p libs
          if [ -n "$HYTALE_SERVER_URL" ]; then
            curl -L -o libs/HytaleServer.jar "$HYTALE_SERVER_URL"
          else
            echo "::error::HYTALE_SERVER_URL secret not set"
            exit 1
          fi

      - name: Update manifest versions
        run: |
          # Update runtime plugin manifest
          sed -i "s/\"Version\": \"[^\"]*\"/\"Version\": \"$VERSION\"/" src/main/resources/manifest.json

          # Update early plugin manifest
          sed -i "s/\"Version\": \"[^\"]*\"/\"Version\": \"$VERSION\"/" hyfixes-early/src/main/resources/manifest.json

          # Update bundle manifest
          sed -i "s/\"Version\": \"[^\"]*\"/\"Version\": \"$VERSION\"/" bundle/manifest.json

          echo "Updated all manifests to version $VERSION"

      - name: Build Runtime Plugin
        run: ./gradlew build -Pversion=${{ env.TAG_VERSION }}

      - name: Build Early Plugin
        run: ./gradlew :hyfixes-early:build -Pversion=${{ env.TAG_VERSION }}

      - name: Generate changelog with Claude
        id: changelog
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          chmod +x .github/scripts/generate-changelog.sh
          CHANGELOG=$(.github/scripts/generate-changelog.sh)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create versioned artifacts and bundle
        run: |
          mkdir -p dist

          # Copy JARs with versioned names
          cp build/libs/hyfixes-*.jar "dist/hyfixes-${VERSION}.jar" 2>/dev/null || \
            cp build/libs/hyfixes.jar "dist/hyfixes-${VERSION}.jar"

          cp hyfixes-early/build/libs/hyfixes-early-*.jar "dist/hyfixes-early-${VERSION}.jar" 2>/dev/null || \
            cp hyfixes-early/build/libs/hyfixes-early.jar "dist/hyfixes-early-${VERSION}.jar"

          # Prepare bundle structure
          mkdir -p dist/bundle/mods dist/bundle/earlyplugins
          cp "dist/hyfixes-${VERSION}.jar" dist/bundle/mods/
          cp "dist/hyfixes-early-${VERSION}.jar" dist/bundle/earlyplugins/
          cp bundle/manifest.json dist/bundle/
          cp CURSEFORGE.md dist/bundle/README.md 2>/dev/null || echo "No CURSEFORGE.md found"

          # Create bundle ZIP
          cd dist/bundle
          zip -r "../hyfixes-bundle-v${VERSION}.zip" .
          cd ../..

          echo "=== Created artifacts ==="
          ls -la dist/

      - name: Verify versions in JARs
        run: |
          echo "=== Version Verification ==="
          echo "Tag version: $VERSION"
          echo "Runtime manifest: $(unzip -p dist/hyfixes-${VERSION}.jar manifest.json | grep -o '"Version": "[^"]*"')"
          echo "Early manifest: $(unzip -p dist/hyfixes-early-${VERSION}.jar manifest.json | grep -o '"Version": "[^"]*"')"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: HyFixes v${{ env.VERSION }}
          body: ${{ steps.changelog.outputs.content }}
          files: |
            dist/hyfixes-${{ env.VERSION }}.jar
            dist/hyfixes-early-${{ env.VERSION }}.jar
            dist/hyfixes-bundle-v${{ env.VERSION }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to CurseForge
        if: ${{ secrets.CURSEFORGE_TOKEN != '' && secrets.CURSEFORGE_PROJECT_ID != '' }}
        uses: itsmeow/curseforge-upload@v3
        with:
          token: ${{ secrets.CURSEFORGE_TOKEN }}
          project_id: ${{ secrets.CURSEFORGE_PROJECT_ID }}
          game_endpoint: hytale
          file_path: dist/hyfixes-bundle-v${{ env.VERSION }}.zip
          display_name: "HyFixes v${{ env.VERSION }}"
          changelog: ${{ steps.changelog.outputs.content }}
          changelog_type: markdown
          release_type: release

      - name: Send Discord notification
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            # Escape changelog for JSON
            CHANGELOG_ESCAPED=$(echo '${{ steps.changelog.outputs.content }}' | head -c 500 | jq -Rs .)

            curl -H "Content-Type: application/json" \
              -X POST \
              -d "{
                \"embeds\": [{
                  \"title\": \"HyFixes v${VERSION} Released!\",
                  \"description\": \"A new version of HyFixes is now available.\",
                  \"color\": 5814783,
                  \"fields\": [
                    {
                      \"name\": \"Downloads\",
                      \"value\": \"[GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${TAG_VERSION})\",
                      \"inline\": false
                    }
                  ],
                  \"footer\": {
                    \"text\": \"HyFixes - Bug fixes for Hytale servers\"
                  },
                  \"url\": \"https://github.com/${{ github.repository }}/releases/tag/${TAG_VERSION}\"
                }]
              }" \
              "$DISCORD_WEBHOOK"
          fi
